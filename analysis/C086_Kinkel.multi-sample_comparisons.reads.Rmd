---
title: "Multi-sample comparisons of the Kinkel (C086) Smchd1 LSK mini-bulk data set"
description: "Read-based analysis"
author:
  - name: Peter Hickey
    url: https://peterhickey.org
    affiliation: WEHI SCORE
    affiliation_url: https://www.wehi.edu.au/people/shalin-naik/3310/score
date: "`r Sys.Date()`"
editor_options:
  chunk_output_type: console
bibliography: ref.bib
---

# Setup

## Summary

- Read counts analysed
- Various analyses denoted by a prefix (`x`, `y`, `ym`, `yf`)
  - `x`: `voomLmFit()` of individual technical replicates, blocking on mouse
  - `y`: `voomLmFit()` of aggregated technical reps
  - `ym`: As with `y` but **males** only
  - `yf`: As with `y` but **females** only

## Load data

```{r}
library(SingleCellExperiment)
library(here)
library(edgeR)
library(ggplot2)
library(cowplot)
library(patchwork)
library(ggrepel)

source(here("code/helper_functions.R"))

sce <- readRDS(
  here("data", "SCEs", "C086_Kinkel.preprocessed.SCE.rds"))

# Some useful colours
sex_colours <- setNames(
  unique(sce$sex_colours),
  unique(names(sce$sex_colours)))
smchd1_genotype_updated_colours <- setNames(
  unique(sce$smchd1_genotype_updated_colours),
  unique(names(sce$smchd1_genotype_updated_colours)))
mouse_number_colours <- setNames(
  unique(sce$mouse_number_colours),
  unique(names(sce$mouse_number_colours)))
```

## Create DGEList objects

```{r}
x <- DGEList(
  counts = as.matrix(assay(sce, "read_counts")),
  samples = colData(sce),
  group = factor(sce$smchd1_genotype_updated),
  genes = flattenDF(rowData(sce)))
x <- x[!matrixStats::rowAlls(x$counts == 0), ]
```

```{r}
y <- sumTechReps(x, x$samples$genotype.mouse)
ym <- y[, y$samples$sex == "M"]
yf <- y[, y$samples$sex == "F"]
```

## Gene filtering

```{r}
x_keep_exprs <- filterByExpr(x, group = x$samples$group)
table(x_keep_exprs)
x <- x[x_keep_exprs, , keep.lib.sizes = FALSE]
```

```{r}
y_keep_exprs <- filterByExpr(y, group = ym$samples$group)
table(y_keep_exprs)
y <- y[y_keep_exprs, , keep.lib.sizes = FALSE]
```

```{r}
ym_keep_exprs <- filterByExpr(ym, group = ym$samples$group)
table(ym_keep_exprs)
ym <- ym[ym_keep_exprs, , keep.lib.sizes = FALSE]
```

```{r}
yf_keep_exprs <- filterByExpr(yf, group = yf$samples$group)
table(yf_keep_exprs)
yf <- yf[yf_keep_exprs, , keep.lib.sizes = FALSE]
```

## Normalization

```{r}
x <- calcNormFactors(x, method = "TMM")
y <- calcNormFactors(y, method = "TMM")
ym <- calcNormFactors(ym, method = "TMM")
yf <- calcNormFactors(yf, method = "TMM")
```

# Analysis of individuals tech reps

## MDS

```{r, fig.asp = 1}
x_mds <- plotMDS(x, plot = FALSE)

x_df <- cbind(data.frame(x = x_mds$x, y = x_mds$y), x$samples)
rownames(x_df) <- colnames(x)

p1 <- ggplot(
  aes(x = x, y = y, colour = smchd1_genotype_updated, label = rownames(x_df)),
  data = x_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = smchd1_genotype_updated_colours)
p2 <- ggplot(
  aes(x = x, y = y, colour = sex, label = rownames(x_df)),
  data = x_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = sex_colours)
p3 <- ggplot(
  aes(x = x, y = y, colour = mouse_number, label = rownames(x_df)),
  data = x_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = mouse_number_colours)
p4 <- ggplot(
  aes(x = x, y = y, colour = log10(lib.size), label = rownames(x_df)),
  data = x_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2")
p5 <- ggplot(
  aes(x = log10(lib.size), y = x, colour = log10(lib.size), label = rownames(x_df)),
  data = x_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 1")
p6 <- ggplot(
  aes(x = log10(lib.size), y = y, colour = log10(lib.size), label = rownames(x_df)),
  data = x_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 2")

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol = 2)
```

### After excluding outliers

```{r}
outliers <- c("Del.1282.2", "Het.1248.2")
```

- Exclude `r paste0(outliers, collapse = ", ")`

```{r, fig.asp = 1}
x2 <- x[, setdiff(colnames(x), outliers)]

x2_mds <- plotMDS(x2, plot = FALSE)

x2_df <- cbind(data.frame(x = x2_mds$x, y = x2_mds$y), x2$samples)
rownames(x2_df) <- colnames(x2)

p1 <- ggplot(
  aes(x = x, y = y, colour = smchd1_genotype_updated, label = rownames(x2_df)),
  data = x2_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = smchd1_genotype_updated_colours)
p2 <- ggplot(
  aes(x = x, y = y, colour = sex, label = rownames(x2_df)),
  data = x2_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = sex_colours)
p3 <- ggplot(
  aes(x = x, y = y, colour = mouse_number, label = rownames(x2_df)),
  data = x2_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = mouse_number_colours)
p4 <- ggplot(
  aes(x = x, y = y, colour = log10(lib.size), label = rownames(x2_df)),
  data = x2_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2")
p5 <- ggplot(
  aes(x = log10(lib.size), y = x, colour = log10(lib.size), label = rownames(x2_df)),
  data = x2_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 1")
p6 <- ggplot(
  aes(x = log10(lib.size), y = y, colour = log10(lib.size), label = rownames(x2_df)),
  data = x2_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 2")

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol = 2)
```

## Array weights

- **TODO**: Interpret voom plot

```{r, fig.asp = 1}
x_o <- order(colnames(x))
x_design <- model.matrix(~0 + smchd1_genotype_updated + sex, x$samples)
colnames(x_design) <- sub("smchd1_genotype_updated", "", colnames(x_design))

x_fit <- voomLmFit(
  x,
  design = x_design,
  block = x$samples$mouse_number,
  sample.weights = TRUE,
  plot = TRUE)
```

- **TODO**: How to interpret small intra-block correlation (` x_fit$cor` = `r x_fit$cor`)?


```{r}
x_aw <- x_fit$targets$sample.weight
names(x_aw) <- colnames(x)
x_aw <- x_aw[x_o]
barplot(
  x_aw,
  col = x$samples$smchd1_genotype_updated_colours[x_o],
  las = 2,
  cex.names = 0.5)
```

## DE analysis

```{r, fig.asp = 1}
x_contrasts <- makeContrasts(Del - Het, levels = x_design)
x_fit <- contrasts.fit(x_fit, x_contrasts)
x_fit <- eBayes(x_fit)

par(mfrow = c(1, 1))
plotSA(x_fit, main="Final model: Mean-variance trend")
```

```{r, fig.asp = 1}
x_dt <- decideTests(x_fit)
summary(x_dt)

par(mfrow = c(1, 1))
plotMD(x_fit, status = x_dt[, 1], main = "Del - Het")
```

```{r}
topTable(x_fit)
```

```{r}
topTable(x_fit, n = Inf)["Smchd1", ]
```

```{r}
par(mfrow = c(1, 2))
hist(
  topTable(x_fit, n = Inf)$P.Value,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "P-value")
hist(
  topTable(x_fit, n = Inf)$adj.P.Val,
  xlim = c(0, 1), 
  breaks = 0:20 / 20,
  main = "Adjusted P-value")
```

# Analysis of aggregated tech reps

## MDS

```{r, fig.asp = 1}
y_mds <- plotMDS(y, plot = FALSE)

y_df <- cbind(data.frame(x = y_mds$x, y = y_mds$y), y$samples)
rownames(y_df) <- colnames(y)

p1 <- ggplot(
  aes(x = x, y = y, colour = smchd1_genotype_updated, label = rownames(y_df)),
  data = y_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = smchd1_genotype_updated_colours)
p2 <- ggplot(
  aes(x = x, y = y, colour = sex, label = rownames(y_df)),
  data = y_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = sex_colours)
p3 <- ggplot(
  aes(x = x, y = y, colour = mouse_number, label = rownames(y_df)),
  data = y_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = mouse_number_colours)
p4 <- ggplot(
  aes(x = x, y = y, colour = log10(lib.size), label = rownames(y_df)),
  data = y_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2")
p5 <- ggplot(
  aes(x = log10(lib.size), y = x, colour = log10(lib.size), label = rownames(y_df)),
  data = y_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 1")
p6 <- ggplot(
  aes(x = log10(lib.size), y = y, colour = log10(lib.size), label = rownames(y_df)),
  data = y_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 2")

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol = 2)
```

## Array weights

- **TODO**: Interpret voom plot

```{r, fig.asp = 1}
y_o <- order(colnames(y))
y_design <- model.matrix(~0 + smchd1_genotype_updated + sex, y$samples)
colnames(y_design) <- sub("smchd1_genotype_updated", "", colnames(y_design))
y_fit <- voomLmFit(
  y,
  design = y_design,
  sample.weights = TRUE,
  plot = TRUE)
```

```{r}
y_aw <- y_fit$targets$sample.weight
names(y_aw) <- colnames(y)
y_aw <- y_aw[y_o]
barplot(y_aw, col = y$samples$smchd1_genotype_updated_colours[y_o], las = 2)
```

### Comparison to individual tech reps

```{r, fig.asp = 1}
par(mfrow = c(2, 1))
barplot(
  x_aw,
  col = x$samples$smchd1_genotype_updated_colours[x_o],
  las = 2,
  cex.names = 0.5)
barplot(y_aw, col = y$samples$smchd1_genotype_updated_colours[y_o], las = 2)
```

## DE analysis

```{r, fig.asp = 1}
y_contrasts <- makeContrasts(Del - Het, levels = y_design)
y_fit <- contrasts.fit(y_fit, y_contrasts)
y_fit <- eBayes(y_fit)

par(mfrow = c(1, 1))
plotSA(y_fit, main="Final model: Mean-variance trend")
```

```{r, fig.asp = 1}
y_dt <- decideTests(y_fit)
summary(y_dt)

par(mfrow = c(1, 1))
plotMD(y_fit, status = y_dt[, 1])
```

```{r}
topTable(y_fit)
```

```{r}
topTable(y_fit, n = Inf)["Smchd1", ]
```

```{r}
par(mfrow = c(1, 2))
hist(
  topTable(y_fit, n = Inf)$P.Value,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "P-value")
hist(
  topTable(y_fit, n = Inf)$adj.P.Val,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "Adjusted P-value")
```

### Gene set tests

- Can't use output of `voomLmFit()`, so have to re-fit model with **edgeR** or `voomWithQualityWeights()`
- Marnie and Sarah interested in chrX as a whole

```{r}
y_X <- y$genes$ENSEMBL.SEQNAME == "X"
```

Using **edgeR**

```{r}
y_index <- list(X = y_X)
y <- estimateDisp(y, design = y_design)
roast(
  y,
  index = y_index,
  design = y_design,
  contrast = y_contrasts,
  nrot = 9999)
```

Using `voomWithQualityWeights()`

```{r}
v_y <- voomWithQualityWeights(y, y_design)
roast(
  v_y,
  index = y_index,
  design = y_design,
  contrast = y_contrasts,
  nrot = 9999)
```

```{r}
y_status <- rep("Other", nrow(y_fit))
y_status[y_X] <- "X"

par(mfrow = c(1, 2))
plotMD(
  y_fit,
  status = y_status,
  values = "X",
  hl.col = "red",
  legend = "bottomright")
abline(h = 0, col = "darkgrey")

barcodeplot(
  y_fit$t[, 1],
  y_X,
  labels = c("Down in Del", "Up in Del"))
```

# Male-only: analysis of aggregated tech reps

## MDS

```{r, fig.asp = 1}
ym_mds <- plotMDS(ym, plot = FALSE)

ym_df <- cbind(data.frame(x = ym_mds$x, y = ym_mds$y), ym$samples)
rownames(ym_df) <- colnames(ym)

p1 <- ggplot(
  aes(x = x, y = y, colour = smchd1_genotype_updated, label = rownames(ym_df)),
  data = ym_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = smchd1_genotype_updated_colours)
p2 <- ggplot(
  aes(x = x, y = y, colour = sex, label = rownames(ym_df)),
  data = ym_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = sex_colours)
p3 <- ggplot(
  aes(x = x, y = y, colour = mouse_number, label = rownames(ym_df)),
  data = ym_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = mouse_number_colours)
p4 <- ggplot(
  aes(x = x, y = y, colour = log10(lib.size), label = rownames(ym_df)),
  data = ym_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2")
p5 <- ggplot(
  aes(x = log10(lib.size), y = x, colour = log10(lib.size), label = rownames(ym_df)),
  data = ym_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 1")
p6 <- ggplot(
  aes(x = log10(lib.size), y = y, colour = log10(lib.size), label = rownames(ym_df)),
  data = ym_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 2")

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol = 2)
```

## Array weights

- **TODO**: Interpret voom plot

```{r, fig.asp = 1}
ym_o <- order(colnames(ym))
ym_design <- model.matrix(~0 + smchd1_genotype_updated, ym$samples)
colnames(ym_design) <- sub("smchd1_genotype_updated", "", colnames(ym_design))
ym_fit <- voomLmFit(
  ym,
  design = ym_design,
  sample.weights = TRUE,
  plot = TRUE)
```

```{r}
ym_aw <- ym_fit$targets$sample.weight
names(ym_aw) <- colnames(ym)
ym_aw <- ym_aw[ym_o]
barplot(ym_aw, col = ym$samples$smchd1_genotype_updated_colours[ym_o], las = 2)
```

## DE analysis

```{r, fig.asp = 1}
ym_contrasts <- makeContrasts(Del - Het, levels = ym_design)
ym_fit <- contrasts.fit(ym_fit, ym_contrasts)
ym_fit <- eBayes(ym_fit)

par(mfrow = c(1, 1))
plotSA(ym_fit, main="Final model: Mean-variance trend")
```

```{r, fig.asp = 1}
ym_dt <- decideTests(ym_fit)
summary(ym_dt)

par(mfrow = c(1, 1))
plotMD(ym_fit, status = ym_dt[, 1])
```

```{r}
topTable(ym_fit)
```

```{r}
topTable(ym_fit, n = Inf)["Smchd1", ]
```

```{r}
par(mfrow = c(1, 2))
hist(
  topTable(ym_fit, n = Inf)$P.Value,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "P-value")
hist(
  topTable(ym_fit, n = Inf)$adj.P.Val,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "Adjusted P-value")
```

### Gene set tests

**TODO**: Large discrepancy between *edgeR** and `voomWithQualityWeights()` results

```{r}
ym_X <- ym$genes$ENSEMBL.SEQNAME == "X"
```

Using **edgeR**

```{r}
ym_index <- list(X = ym_X)
ym <- estimateDisp(ym, design = ym_design)
roast(
  ym,
  index = ym_index,
  design = ym_design,
  contrast = ym_contrasts,
  nrot = 9999)
```

Using `voomWithQualityWeights()`

```{r}
v_ym <- voomWithQualityWeights(ym, ym_design)
roast(
  v_ym,
  index = ym_index,
  design = ym_design,
  contrast = ym_contrasts,
  nrot = 9999)
```

```{r}
ym_status <- rep("Other", nrow(ym_fit))
ym_status[ym_X] <- "X"

par(mfrow = c(1, 2))
plotMD(
  ym_fit,
  status = ym_status,
  values = "X",
  hl.col = "red",
  legend = "bottomright")
abline(h = 0, col = "darkgrey")

barcodeplot(
  ym_fit$t[, 1],
  ym_X,
  labels = c("Down in Del", "Up in Del"))
```

# Female-only: analysis of aggregated tech reps

## MDS

```{r, fig.asp = 1}
yf_mds <- plotMDS(yf, plot = FALSE)

yf_df <- cbind(data.frame(x = yf_mds$x, y = yf_mds$y), yf$samples)
rownames(yf_df) <- colnames(yf)

p1 <- ggplot(
  aes(x = x, y = y, colour = smchd1_genotype_updated, label = rownames(yf_df)),
  data = yf_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = smchd1_genotype_updated_colours)
p2 <- ggplot(
  aes(x = x, y = y, colour = sex, label = rownames(yf_df)),
  data = yf_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = sex_colours)
p3 <- ggplot(
  aes(x = x, y = y, colour = mouse_number, label = rownames(yf_df)),
  data = yf_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_colour_manual(values = mouse_number_colours)
p4 <- ggplot(
  aes(x = x, y = y, colour = log10(lib.size), label = rownames(yf_df)),
  data = yf_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2")
p5 <- ggplot(
  aes(x = log10(lib.size), y = x, colour = log10(lib.size), label = rownames(yf_df)),
  data = yf_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 1")
p6 <- ggplot(
  aes(x = log10(lib.size), y = y, colour = log10(lib.size), label = rownames(yf_df)),
  data = yf_df) +
  geom_point() +
  geom_text_repel(size = 4) +
  theme_cowplot(font_size = 8) +
  scale_colour_viridis_c() +
  ylab("Leading logFC dim 2")

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol = 2)
```

## Array weights

- **TODO**: Interpret voom plot

```{r, fig.asp = 1}
yf_o <- order(colnames(yf))
yf_design <- model.matrix(~0 + smchd1_genotype_updated, yf$samples)
# NOTE: Drop WT column as there are no female WT samples.
yf_design <- yf_design[, colSums(yf_design) > 0]
colnames(yf_design) <- sub("smchd1_genotype_updated", "", colnames(yf_design))
yf_fit <- voomLmFit(
  yf,
  design = yf_design,
  sample.weights = TRUE,
  plot = TRUE)
```

```{r}
yf_aw <- yf_fit$targets$sample.weight
names(yf_aw) <- colnames(yf)
yf_aw <- yf_aw[yf_o]
barplot(yf_aw, col = yf$samples$smchd1_genotype_updated_colours[yf_o], las = 2)
```

## DE analysis

```{r, fig.asp = 1}
yf_contrasts <- makeContrasts(Del - Het, levels = yf_design)
yf_fit <- contrasts.fit(yf_fit, yf_contrasts)
yf_fit <- eBayes(yf_fit)

par(mfrow = c(1, 1))
plotSA(yf_fit, main="Final model: Mean-variance trend")
```

```{r, fig.asp = 1}
yf_dt <- decideTests(yf_fit)
summary(yf_dt)

par(mfrow = c(1, 1))
plotMD(yf_fit, status = yf_dt[, 1])
```

```{r}
topTable(yf_fit)
```

```{r}
topTable(yf_fit, n = Inf)["Smchd1", ]
```

```{r}
par(mfrow = c(1, 2))
hist(
  topTable(yf_fit, n = Inf)$P.Value,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "P-value")
hist(
  topTable(yf_fit, n = Inf)$adj.P.Val,
  xlim = c(0, 1),
  breaks = 0:20 / 20,
  main = "Adjusted P-value")
```

### Gene set tests

```{r}
yf_X <- yf$genes$ENSEMBL.SEQNAME == "X"
```

Using **edgeR**

```{r}
yf_index <- list(X = yf_X)
yf <- estimateDisp(yf, design = yf_design)
roast(
  yf,
  index = yf_index,
  design = yf_design,
  contrast = yf_contrasts,
  nrot = 9999)
```

Using `voomWithQualityWeights()`

```{r}
v_yf <- voomWithQualityWeights(yf, yf_design)
roast(
  v_yf,
  index = yf_index,
  design = yf_design,
  contrast = yf_contrasts,
  nrot = 9999)
```

```{r}
yf_status <- rep("Other", nrow(yf_fit))
yf_status[yf_X] <- "X"

par(mfrow = c(1, 2))
plotMD(
  yf_fit,
  status = yf_status,
  values = "X",
  hl.col = "red",
  legend = "bottomright")
abline(h = 0, col = "darkgrey")

barcodeplot(
  yf_fit$t[, 1],
  yf_X,
  labels = c("Down in Del", "Up in Del"))
```

# TODOs

- [ ] Exclude pseudogenes and all that crap?
- [ ] Compare gene lists from analysis of `x` and `y`

# Session info {.appendix}

<summary>The analysis and this document were prepared using the following software (click triangle to expand)</summary>
<details>

```{r}
sessioninfo::session_info()
```

</details>

